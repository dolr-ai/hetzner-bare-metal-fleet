name: Provision Bare Metal Servers

on:
  # Manual trigger only
  workflow_dispatch:
    inputs:
      target_hosts:
        description: "Specific host to provision (must be in rescue mode)"
        required: true
        type: string
      drive_type:
        description: "Drive type"
        required: true
        default: "nvme0n1"
        type: choice
        options:
          - nvme0n1
          - sda
      skip_provisioning_check:
        description: "Skip check if server is already provisioned (use with caution)"
        required: false
        default: false
        type: boolean

env:
  ANSIBLE_HOST_KEY_CHECKING: False
  ANSIBLE_FORCE_COLOR: True

jobs:
  provision-servers:
    name: Provision Servers
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Ansible and dependencies
        run: |
          pip install --upgrade pip
          pip install ansible ansible-core yq
          ansible-galaxy collection install ansible.posix community.general

      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.HETZNER_BARE_METAL_GITHUB_ACTIONS_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_ed25519

      - name: Set up Ansible vault password
        env:
          VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
        run: |
          if [ -z "$VAULT_PASSWORD" ]; then
            echo "::error::ANSIBLE_VAULT_PASSWORD secret is not set or is empty"
            echo "Please add the vault password as a repository secret named ANSIBLE_VAULT_PASSWORD"
            exit 1
          fi
          cd ansible
          echo "$VAULT_PASSWORD" > .vault_pass
          chmod 600 .vault_pass
          echo "✓ Vault password file created"

      - name: Determine target hosts
        id: target
        run: |
          echo "hosts=${{ inputs.target_hosts }}" >> $GITHUB_OUTPUT
          echo "drive=${{ inputs.drive_type }}" >> $GITHUB_OUTPUT

      - name: Test connectivity to target hosts
        run: |
          cd ansible
          # Convert comma-separated to colon-separated for Ansible limit
          targets="${{ steps.target.outputs.hosts }}"
          ansible ${targets//,/:} -m ping -v || true

      - name: Pre-provisioning checks
        run: |
          cd ansible
          targets="${{ steps.target.outputs.hosts }}"
          echo "## Pre-Provisioning Checks" >> $GITHUB_STEP_SUMMARY
          echo "Checking rescue mode status for: $targets" >> $GITHUB_STEP_SUMMARY

          # Check each host
          IFS=',' read -ra HOSTS <<< "$targets"
          for host in "${HOSTS[@]}"; do
            echo "### $host" >> $GITHUB_STEP_SUMMARY
            rescue_check=$(ansible $host -m raw -a "test -f /root/.oldroot/nfs/install/installimage && echo 'rescue' || echo 'not_rescue'" 2>/dev/null || echo "unreachable")
            if echo "$rescue_check" | grep -q "rescue"; then
              echo "✅ In rescue mode" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ NOT in rescue mode or unreachable" >> $GITHUB_STEP_SUMMARY
              echo "::warning::Host $host is not in rescue mode. Provisioning will fail."
            fi
          done

      - name: Run bare metal provisioning
        run: |
          cd ansible
          targets="${{ steps.target.outputs.hosts }}"
          ansible-playbook \
            --limit ${targets//,/:} \
            -e "drive_to_use=${{ steps.target.outputs.drive }}" \
            -v \
            playbooks/bare-metal-provision.yml

      - name: Generate provisioning summary
        if: always()
        run: |
          echo "## Bare Metal Provisioning Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Target Hosts:** ${{ steps.target.outputs.hosts }}" >> $GITHUB_STEP_SUMMARY
          echo "**Drive Type:** ${{ steps.target.outputs.drive }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Upload Ansible logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: provisioning-logs-${{ github.run_id }}
          path: |
            ansible/ansible.log
          retention-days: 30

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Provisioning failed for: ${{ steps.target.outputs.hosts }}"
          echo "Check that servers are in rescue mode and accessible via SSH"
