name: Provision New Bare Metal Servers

on:
  # Trigger when hosts.yml is modified
  push:
    branches: [main]
    paths:
      - "ansible/inventory/hosts.yml"

  # Manual trigger for specific hosts
  workflow_dispatch:
    inputs:
      target_hosts:
        description: "Specific host to provision (must be in rescue mode)"
        required: true
        type: string
      drive_type:
        description: "Drive type"
        required: true
        default: "nvme0n1"
        type: choice
        options:
          - nvme0n1
          - sda
      skip_provisioning_check:
        description: "Skip check if server is already provisioned (use with caution)"
        required: false
        default: false
        type: boolean

env:
  ANSIBLE_HOST_KEY_CHECKING: False
  ANSIBLE_FORCE_COLOR: True
  PROVISIONED_HOSTS_FILE: .github/.provisioned-hosts

jobs:
  detect-new-hosts:
    name: Detect New Hosts
    runs-on: ubuntu-latest
    outputs:
      new_hosts: ${{ steps.find-new.outputs.hosts }}
      has_new_hosts: ${{ steps.find-new.outputs.has_new }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need previous commit to compare

      - name: Restore provisioned hosts cache
        uses: actions/cache@v3
        with:
          path: ${{ env.PROVISIONED_HOSTS_FILE }}
          key: provisioned-hosts-${{ github.sha }}
          restore-keys: |
            provisioned-hosts-

      - name: Create provisioned hosts file if not exists
        run: |
          mkdir -p .github
          touch ${{ env.PROVISIONED_HOSTS_FILE }}

      - name: Find new hosts
        id: find-new
        run: |
          # Extract all hostnames from current hosts.yml
          current_hosts=$(yq eval '.all.children.bare_metal.hosts | keys | .[]' ansible/inventory/hosts.yml)

          # Read already provisioned hosts
          if [ -f "${{ env.PROVISIONED_HOSTS_FILE }}" ]; then
            provisioned_hosts=$(cat ${{ env.PROVISIONED_HOSTS_FILE }})
          else
            provisioned_hosts=""
          fi

          # Find new hosts (in current but not in provisioned)
          new_hosts=""
          for host in $current_hosts; do
            if ! echo "$provisioned_hosts" | grep -q "^${host}$"; then
              if [ -z "$new_hosts" ]; then
                new_hosts="$host"
              else
                new_hosts="$new_hosts,$host"
              fi
            fi
          done

          if [ -n "$new_hosts" ]; then
            echo "has_new=true" >> $GITHUB_OUTPUT
            echo "hosts=$new_hosts" >> $GITHUB_OUTPUT
            echo "::notice::New hosts detected: $new_hosts"
          else
            echo "has_new=false" >> $GITHUB_OUTPUT
            echo "hosts=" >> $GITHUB_OUTPUT
            echo "::notice::No new hosts detected"
          fi

      - name: Display detection results
        run: |
          echo "## New Hosts Detection" >> $GITHUB_STEP_SUMMARY
          echo "**Has New Hosts:** ${{ steps.find-new.outputs.has_new }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.find-new.outputs.has_new }}" == "true" ]; then
            echo "**New Hosts:** ${{ steps.find-new.outputs.hosts }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **IMPORTANT:** These servers must be in Hetzner rescue mode before provisioning!" >> $GITHUB_STEP_SUMMARY
          fi

  provision-servers:
    name: Provision Servers
    runs-on: ubuntu-latest
    needs: detect-new-hosts
    if: needs.detect-new-hosts.outputs.has_new_hosts == 'true' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Ansible and dependencies
        run: |
          pip install --upgrade pip
          pip install ansible ansible-core yq
          ansible-galaxy collection install ansible.posix community.general

      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.HETZNER_BARE_METAL_GITHUB_ACTIONS_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_ed25519

      - name: Set up Ansible vault password
        env:
          VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
        run: |
          if [ -z "$VAULT_PASSWORD" ]; then
            echo "::error::ANSIBLE_VAULT_PASSWORD secret is not set or is empty"
            echo "Please add the vault password as a repository secret named ANSIBLE_VAULT_PASSWORD"
            exit 1
          fi
          cd ansible
          echo "$VAULT_PASSWORD" > .vault_pass
          chmod 600 .vault_pass
          echo "✓ Vault password file created"

      - name: Determine target hosts
        id: target
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "hosts=${{ inputs.target_hosts }}" >> $GITHUB_OUTPUT
            echo "drive=${{ inputs.drive_type }}" >> $GITHUB_OUTPUT
          else
            echo "hosts=${{ needs.detect-new-hosts.outputs.new_hosts }}" >> $GITHUB_OUTPUT
            echo "drive=nvme0n1" >> $GITHUB_OUTPUT
          fi

      - name: Test connectivity to target hosts
        run: |
          cd ansible
          # Convert comma-separated to colon-separated for Ansible limit
          targets="${{ steps.target.outputs.hosts }}"
          ansible ${targets//,/:} -m ping -v || true

      - name: Pre-provisioning checks
        run: |
          cd ansible
          targets="${{ steps.target.outputs.hosts }}"
          echo "## Pre-Provisioning Checks" >> $GITHUB_STEP_SUMMARY
          echo "Checking rescue mode status for: $targets" >> $GITHUB_STEP_SUMMARY

          # Check each host
          IFS=',' read -ra HOSTS <<< "$targets"
          for host in "${HOSTS[@]}"; do
            echo "### $host" >> $GITHUB_STEP_SUMMARY
            rescue_check=$(ansible $host -m raw -a "test -f /root/.oldroot/nfs/install/installimage && echo 'rescue' || echo 'not_rescue'" 2>/dev/null || echo "unreachable")
            if echo "$rescue_check" | grep -q "rescue"; then
              echo "✅ In rescue mode" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ NOT in rescue mode or unreachable" >> $GITHUB_STEP_SUMMARY
              echo "::warning::Host $host is not in rescue mode. Provisioning will fail."
            fi
          done

      - name: Run bare metal provisioning
        run: |
          cd ansible
          targets="${{ steps.target.outputs.hosts }}"
          ansible-playbook \
            --limit ${targets//,/:} \
            -e "drive_to_use=${{ steps.target.outputs.drive }}" \
            -v \
            playbooks/bare-metal-provision.yml

      - name: Mark hosts as provisioned
        if: success()
        run: |
          mkdir -p .github
          targets="${{ steps.target.outputs.hosts }}"
          IFS=',' read -ra HOSTS <<< "$targets"
          for host in "${HOSTS[@]}"; do
            echo "$host" >> ${{ env.PROVISIONED_HOSTS_FILE }}
          done
          sort -u ${{ env.PROVISIONED_HOSTS_FILE }} -o ${{ env.PROVISIONED_HOSTS_FILE }}

      - name: Save provisioned hosts cache
        if: success()
        uses: actions/cache/save@v3
        with:
          path: ${{ env.PROVISIONED_HOSTS_FILE }}
          key: provisioned-hosts-${{ github.sha }}

      - name: Commit provisioned hosts list
        if: success() && github.event_name != 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ env.PROVISIONED_HOSTS_FILE }}
          git diff-index --quiet HEAD || git commit -m "chore: update provisioned hosts [skip ci]"
          git push

      - name: Generate provisioning summary
        if: always()
        run: |
          echo "## Bare Metal Provisioning Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Target Hosts:** ${{ steps.target.outputs.hosts }}" >> $GITHUB_STEP_SUMMARY
          echo "**Drive Type:** ${{ steps.target.outputs.drive }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Upload Ansible logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: provisioning-logs-${{ github.run_id }}
          path: |
            ansible/ansible.log
          retention-days: 30

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Provisioning failed for: ${{ steps.target.outputs.hosts }}"
          echo "Check that servers are in rescue mode and accessible via SSH"
