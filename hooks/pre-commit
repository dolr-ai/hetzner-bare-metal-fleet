#!/bin/bash
# Git pre-commit hook to automatically encrypt beszel agent tokens
# This ensures host_vars files are always encrypted before committing

set -e

# Colors for output (disable if running in non-interactive environment like VS Code)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    NC=''
fi

HOST_VARS_DIR="ansible/inventory/host_vars"
VAULT_PASSWORD_FILE="ansible/.vault_pass"

# Check if ansible-vault is available
if ! command -v ansible-vault &> /dev/null; then
    echo -e "${RED}Error: ansible-vault command not found${NC}"
    echo "Please install Ansible:"
    echo "  pip install ansible"
    echo "  # or"
    echo "  sudo apt install ansible-core"
    exit 1
fi

# Check if vault password file exists
if [ ! -f "$VAULT_PASSWORD_FILE" ]; then
    echo -e "${RED}Error: Vault password file not found at $VAULT_PASSWORD_FILE${NC}"
    echo "Please create it with: echo 'your-vault-password' > $VAULT_PASSWORD_FILE"
    exit 1
fi

# Get list of staged host_vars yml files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^${HOST_VARS_DIR}/.*\.yml$" || true)

if [ -z "$STAGED_FILES" ]; then
    # No host_vars files staged, continue with commit
    exit 0
fi

if [ -t 1 ]; then
    echo -e "${YELLOW}Checking host_vars files for encryption...${NC}"
fi

ENCRYPTED_COUNT=0
ALREADY_ENCRYPTED_COUNT=0
NEEDS_ENCRYPTION=()

# Check each staged file
for file in $STAGED_FILES; do
    if [ ! -f "$file" ]; then
        # File was deleted, skip it
        continue
    fi
    
    # Check if file is encrypted (ansible vault files start with $ANSIBLE_VAULT)
    if head -n 1 "$file" | grep -q '^\$ANSIBLE_VAULT'; then
        if [ -t 1 ]; then
            echo -e "${GREEN}✓${NC} $file is already encrypted"
        fi
        ALREADY_ENCRYPTED_COUNT=$((ALREADY_ENCRYPTED_COUNT + 1))
    else
        if [ -t 1 ]; then
            echo -e "${YELLOW}!${NC} $file needs encryption"
        fi
        NEEDS_ENCRYPTION+=("$file")
    fi
done

# Encrypt files that need it
if [ ${#NEEDS_ENCRYPTION[@]} -gt 0 ]; then
    if [ -t 1 ]; then
        echo ""
        echo -e "${YELLOW}Encrypting ${#NEEDS_ENCRYPTION[@]} file(s)...${NC}"
    fi
    
    for file in "${NEEDS_ENCRYPTION[@]}"; do
        # Encrypt the file
        ansible-vault encrypt "$file" --vault-password-file="$VAULT_PASSWORD_FILE" 2>/dev/null
        
        if [ $? -eq 0 ]; then
            # Re-add the encrypted file to staging
            git add "$file"
            if [ -t 1 ]; then
                echo -e "${GREEN}✓${NC} Encrypted and staged: $file"
            fi
            ENCRYPTED_COUNT=$((ENCRYPTED_COUNT + 1))
        else
            echo -e "${RED}✗${NC} Failed to encrypt: $file"
            exit 1
        fi
    done
    
    if [ -t 1 ]; then
        echo ""
        echo -e "${GREEN}Successfully encrypted $ENCRYPTED_COUNT file(s)${NC}"
        if [ $ALREADY_ENCRYPTED_COUNT -gt 0 ]; then
            echo -e "${GREEN}$ALREADY_ENCRYPTED_COUNT file(s) were already encrypted${NC}"
        fi
    fi
fi

exit 0
